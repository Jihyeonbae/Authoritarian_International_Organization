---
title: "Authoritarian International Organization: Constructing Dataset"
author: "Jihyeon Bae"
date: "2023-12-13"
output:
  html:
---

# Introduction

## Background and Goals

- Authoritarian Intergovernmental Organizations (AIGO): formal IGOs that largely comprise authoritarian states 
  - Creating aggregate level variable based on country-level data
  - Creating indices for robustness check

- Finding distinctive patterns of AIO compared to democratic counterparts

# Setup and packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("pacman")
p_load(plyr, dplyr, tidyr, ggplot2, tidyverse, RColorBrewer, readxl,
       readr, haven, countrycode,
       rqog, igoR, modelsummary, knitr)
```

# Loading Raw data
```{r, echo=FALSE, warning=FALSE}

#Qualities of Government
qog<-rqog::read_qog(which_data = "standard", data_type = "time-series") 
qog<-qog%>%
  filter(year>=1970 & year<2022) 

#Measuring International Authority
MIA <- read_dta("~/Desktop/International-Organizations/DP_May 2021.dta")

#Correlates of War
COW<-igoR::igo_year_format3 %>%
  filter(year>=1970)
```

---

# Country-level variables

```{r}
country <-qog %>%
  dplyr::select(cname, year, ccodecow, 
         # World Development Indicators
          wdi_gdpcapcon2015, wdi_pop, wdi_trade, 
         # Rule of Law
          wjp_overall, wbgi_rle,
         # Security variables
          wbgi_pve, cspf_sfi, atop_number,
         # Democracy Indices 
          vdem_polyarchy, vdem_libdem,
         # Democracy Indices (Alternatives for robustness check)
          p_polity2, chga_demo, bmr_dem,
         # Globalization Index
           kofgi_dr_eg=dr_eg,
           kofgi_dr_ig=dr_ig,
           kofgi_dr_pg=dr_pg,
           kofgi_dr_sg=dr_sg) %>% 
  dplyr::mutate(wdi_log_gdpcapcon2015=log(wdi_gdpcapcon2015),
         wdi_log_pop=log(wdi_pop),
         wdi_log_trade=log(wdi_trade))%>%
  dplyr::rename(ccode=ccodecow)%>%
  dplyr::relocate(ccode, cname, year) 
```

```{r, echo=FALSE}
#Check rows that have NA values for VARIABLE_OF_INTEREST
country[is.na(country$ccode),]

#Fill in NAs
country$ccode[country$cname == "Ethiopia"] <- 530
country$ccode[country$cname == "Germany"] <- 255
country$ccode[country$cname == "Yemen Democratic"] <- 680
country$ccode[country$cname == "Yemen"] <- 679
country$ccode[country$cname == "Sudan"] <- 625
country$ccode[country$cname == "Cyprus"] <- 352
country$ccode[country$cname == "Pakistan"] <- 770
country$ccode[country$cname == "Vietnam, North"] <- 816
country$ccode[country$cname == "Vietnam, South"] <- 817
country$cname[country$cname == "USSR"] <- "Russian Federation (the)"


#Run below code to check year-availability for VARIABLE_OF_INTEREST
#summary(country[!is.na(country$VARIABLE_OF_INTEREST),])

country<-country%>%
  filter(!is.na(ccode))
```

---

## Transposing IGO-level data into country-level data

- Pivot longer so that row represents country
```{r}
COW <- COW %>%
  dplyr::rename(cow_igocode = ionum)%>%
  dplyr::select(-c(igocode, version, accuracyofpre1965membershipdates,sourcesandnotes, imputed)) %>%
  dplyr::relocate(cow_igocode, ioname, year, political, social, economic)%>%
  pivot_longer(c(`afghanistan`:`zimbabwe`),
                      names_to="country",
                      values_to="membership")%>%
  dplyr::filter(membership==1) #member states only

```

## Identify ambiguous country names
```{r}
COW <- COW %>%
  mutate(country = recode(country, "austriahungary" = "Austria-Hungary",
                          "domrepublic"="Dominican Republic",
                          "etimor"="East Timor",
                          "hessegrand"="Hesse Grand Ducal",
                          "micronesiafs"="Federated States of Micronesia",
                          "nokorea"="North Korea",
                          "soafrica"="South Africa",
                          "sokorea"="South Korea",
                          "stlucia"="St. Lucia",
                          "wgermany"="German Federal Republic",
                          "syemen"="Yemen People's Republic",
                          .default = country))

#Attaching Country numeric code to character values
COW$ccode<-countrycode(COW$country, 
              origin='country.name', 
              destination='cown', 
              warn = TRUE)

COW<-COW%>%
  filter(!is.na(ccode))
```

---

## Extracting member-state information for each IGO
```{r}
igo_master <- COW %>%
  dplyr::left_join(country, by=c("ccode", "year"))

igo_master <- igo_master %>%
  dplyr::select(-c(orgname, longorgname, membership)) %>%
  dplyr::mutate(share = wdi_log_gdpcapcon2015/sum(wdi_log_gdpcapcon2015),
                poly_share = vdem_polyarchy/sum(vdem_polyarchy),
                hh_poly =sum(poly_share*poly_share))
                
```

---

# Variable Generation
## summarising state level info to igo level
```{r}
igo <- igo_master %>%
  dplyr::group_by(cow_igocode, ioname, year) %>%
  dplyr::summarise(#average democracy scores
                polyarchy =mean(vdem_polyarchy, na.rm=T),
                polyarchy_median =median(vdem_polyarchy, na.rm=T),
                libdem =mean(vdem_libdem, na.rm=T),
                libdem_median =median(vdem_libdem, na.rm=T),
                polity =mean(p_polity2, na.rm=T),
                polity_median =median(p_polity2, na.rm=T),
                #economic variables
                gdp_cap =mean(wdi_log_gdpcapcon2015, na.rm=T),
                alliances =mean(atop_number, na.rm=T),
                #characteristics 
                number =n(),
                trade =mean(wdi_log_trade, na.rm=T),
                percentage =sum(bmr_dem, na.rm=T)/number,
                political =mean(political, na.rm=T),
                social =mean(social, na.rm=T),
                economic =mean(economic, na.rm=T),
                #asymmetry index
                polity_sd =sd(p_polity2, na.rm=T),
                polyarchy_sd =sd(vdem_polyarchy, na.rm=T),
                econ_sd =sd(wdi_log_gdpcapcon2015, na.rm=T),
                hhi_poly =hh_poly-(1/number, na.rm=T),
                hh =sum(share*share, na.rm=T))

```

---

# merging with MIA data
```{r}
MIA <- MIA %>%
  dplyr::select(ionumber, year, inception, typeI, pooling, delegation, delconstit, poolconstit, DS_sum_st)%>%
  dplyr::rename(cow_igocode = ionumber)

igo_dataset <- MIA %>% dplyr::right_join(igo, by = c("cow_igocode", "year"))
```

---

# Data Analysis

## Trend of International Organizations Over Time
```{r}

igo_analysis <- igo_dataset%>%
  dplyr::mutate(AIGO = ifelse(polyarchy < 0.5, 1, 0),
                DIGO = ifelse(polyarchy >=0.5, 1, 0)) %>%
  dplyr::mutate_all(~ifelse(is.nan(.), NA, .)) %>%
  dplyr::arrange(ioname, year) %>%
  dplyr::select(ioname, year, polyarchy, everything())%>%
  as.data.frame()

datasummary(All(igo_analysis) ~ Mean + SD + Min + Max,
            data = igo_analysis,
            output = 'markdown')

```

---

## Automate the process
```{r}
dem_measure <- function(data, measure_var, threshold = 0.5) {
  processed_data <- data %>%
    mutate(AIGO = ifelse({{measure_var}} < threshold, 1, 0),
           DIGO = ifelse({{measure_var}} >= threshold, 1, 0)) %>%
    mutate_all(~ ifelse(is.nan(.), NA, .)) %>%
    arrange(ioname, year) %>%
    select(ioname, year, {{measure_var}}, everything()) %>%
    as.data.frame()%>%
    group_by(year) %>%
    summarise(DIGO = sum(DIGO, na.rm=TRUE),
            AIGO = sum(AIGO, na.rm=TRUE))
    }
  

analysis_polyarchy <- dem_measure(igo_dataset, polyarchy, threshold = 0.5)
analysis_percentage <- dem_measure(igo_dataset, percentage, threshold = 0.5)
analysis_polity <- dem_measure(igo_dataset, polity, threshold = 0)
analysis_libdem <- dem_measure(igo_dataset, libdem, threshold = 0.5)
```

---

## Data Visualization
```{r}
library(ggplot2)
library(gridExtra)

plot <- function(data, title_suffix) {
  ggplot(data, aes(x = year)) +
    geom_line(aes(y = DIGO, color = "DIGO"), color="black", linetype="solid") +
    geom_line(aes(y = AIGO, color = "AIGO"), color="black", linetype="dashed") +
    labs(title = paste("DIGO and AIGO (", title_suffix, ")", sep = ""),
         y = "Count", x="Year") +
    theme_minimal()+
    theme(plot.title=element_text(hjust=0.5))
}

plot_polyarchy <- plot(analysis_polyarchy, "Polyarchy")
plot_percentage <- plot(analysis_percentage, "Percentage")
plot_polity <- plot(analysis_polity, "Polity")
plot_libdem <- plot(analysis_libdem, "Liberal Democracy")

grid.arrange(plot_polyarchy, plot_percentage, plot_polity, plot_libdem, nrow=2)
```

---

## Difference in Pattern?
```{r}
library(lmtest)
library(plm)
model1 <-plm(DS_sum_st
            ~ polyarchy + polyarchy_sd +
              econ_sd + gdp_cap + alliances + number + trade +political + social,
            data = igo_analysis,
            index = c("year", "cow_igocode"),
            model = "within",
            effect = "twoways"
)
summary(model1, vcovBK(model1))

model2 <-plm(DS_sum_st
            ~ polyarchy + hh +
              econ_sd + gdp_cap + alliances + number + trade +political + social,
            data = igo_analysis,
            index = c("year"),
            model = "within",
            effect = "time"
)
summary(model2, vcovBK(model2))
```


## Visualization
```{r}
library(modelsummary)
library(kableExtra)
models <- list("Two-way"=model1, "Time FE"=model2) 

modelsummary(models,  
             stars=TRUE,
          vcov=list(vcovBK(model1), vcovBK(model2)),
          coef_omit = 'Interc')
    
```

